<html>
<head>
<meta charset="utf-8"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs-3.3.7/jq-3.3.1/jszip-2.5.0/dt-1.10.18/b-1.5.4/b-colvis-1.5.4/b-flash-1.5.4/b-html5-1.5.4/datatables.min.css"/>
<style>
	/* TODO
	white-space: break-word;
	word-break: break-all;
	use JS to pre-process your content to perhaps insert zero-width spaces after commas, or perhaps do that on the server side. */
th { font-size: 14px; }
td { font-size: 14px; }
.dataTable tbody td {
	word-break: break-word;
	vertical-align: top;
}
.table-responsive { max-width: 90%; margin-left: auto; margin-right: auto; overflow-x: visible }
</style>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/bs-3.3.7/jq-3.3.1/jszip-2.5.0/dt-1.10.18/b-1.5.4/b-colvis-1.5.4/b-flash-1.5.4/b-html5-1.5.4/datatables.min.js"></script>
</head>
<body>
<div class="table-responsive">
	<div>
		<ul class="nav nav-tabs" role="tablist">
			<li>
				<a href="#tab-table1" data-toggle="tab">Simulation</a>
			</li>
			<li>
				<a href="#tab-table2" data-toggle="tab">Translation</a>
			</li>
			<li class="active">
				<a href="#tab-table3" data-toggle="tab">Comparison</a>
			</li>
		</ul>
	</div>
	<div>
		<p margin-top="1em"> </p>
	</div>
	<div class="tab-content">
		<div class="tab-pane" id="tab-table1">
		</div>
		<div class="tab-pane" id="tab-table2">
		</div>
		<div class="tab-pane active" id="tab-table3">
			<table id="myTable3" class="table table-striped table-bordered" cellspacing="0">
				<thead>
					<tr>
						<th>Model</th>
						<th>Variables</th>
						<th>Success</th>
						<th>Results File</th>
						<th>comp_dirs</th>
					</tr>
				</thead>
			</table>
		</div>
	</div>
</div>
</body>
<script>
$(document).ready(function() {
	$.fn.dataTable.ext.errMode = function( ) {
		console.log('Ignore datatable ajax warning.');
	}
	if (!/jmodelica/i.test('$SIMULATOR_LOG')) {
		["tab-table1", "tab-table2"].forEach( function(v) {
			document.getElementById(v).innerHTML =
			"<br /><h5>Simulation and translation statistics are only available for JModelica at the moment.</h5>";
		});
	} else {
		document.getElementById("tab-table1").innerHTML = `
			<table id="myTable1" class="table table-striped table-bordered" cellspacing="0" >
				<thead>
					<tr>
						<th>Model</th>
						<th>CPU (s)</th>
						<th>Start (s)</th>
						<th>Final (s)</th>
						<th>Success</th>
						<th>Message</th>
					</tr>
				</thead>
			</table>
		`;
		document.getElementById("tab-table2").innerHTML = `
			<table id="myTable2" class="table table-striped table-bordered" cellspacing="0">
				<thead>
					<tr>
						<th>Model</th>
						<th>CPU (s)</th>
						<th>Success</th>
						<th>Warnings</th>
					</tr>
				</thead>
			</table>
		`;
		var table1 = $('#myTable1').DataTable({
			autoWidth: false,
			aLengthMenu: [
					[10, 50, 100, -1],
					[10, 50, 100, "All"]
			],
			iDisplayLength: -1,
			ajax: {
				url: '$SIMULATOR_LOG',
				dataSrc: ''
			},
			columns: [
				{ data: 'model', width: "30%",
					render: function (data, type, full) {
					return data.replace(/\./g, '.<wbr>');}
				},
				{ data: 'simulation.cpu_time',
					render: $.fn.dataTable.render.number( ' ', '.', 2) },
				{ data: 'simulation.start_time',
					render: $.fn.dataTable.render.number( ' ', '.', 2) },
				{ data: 'simulation.final_time',
					render: $.fn.dataTable.render.number( ' ', '.', 2) },
				{ data: 'simulation.success' },
				{ data: 'simulation.message', width: "40%" },
			],
		});
		var table2 = $('#myTable2').DataTable({
			autoWidth: false,
			aLengthMenu: [
					[10, 50, 100, -1],
					[10, 50, 100, "All"]
			],
			iDisplayLength: -1,
			ajax: {
				url: '$SIMULATOR_LOG',
				dataSrc: ''
			},
			columns: [
				{ data: 'model', width: "30%",
					render: function (data, type, full) {
					return data.replace(/\./g, '.<wbr>');}
				},
				{ data: 'translation.cpu_time',
					render: $.fn.dataTable.render.number( ' ', '.', 2) },
				{ data: 'translation.success' },
				{ data: 'translation.warnings', width: "40%" },
			],
		} );
	}
	var table3 = $('#myTable3').DataTable({
		autoWidth: false,
		aLengthMenu: [
        [10, 50, 100, -1],
        [10, 50, 100, "All"]
    ],
		iDisplayLength: -1,
		ajax: {
			url: '$SIMULATOR_LOG',
			dataSrc: ''
		},
		columns: [
			{ data: 'model', width: "30%",
			  render: function (data, type, full) {
				return data.replace(/\./g, '.<wbr>');}
			},
			{ data: 'comparison.variables', width: "60%",
			  render: function (data, type, full) {
				return data.map(function(e) {return '<wbr> ' + e});}
			},
			{ data: 'comparison.success_rate',
			  render: function (data, type, full) {
				var out = "";
				if (!(data === undefined)) {
					out = data.toLocaleString('en-US', {style: "percent"});}
				return '<a class="myClass">' + out + '</a>';}
			},
			{ data: 'comparison.file_name' },
			{ data: 'comparison.funnel_dirs' },
			{ data: 'comparison.var_groups' },
		],
		columnDefs: [
			{ visible: false, searchable: false, targets: [3, 4, 5] },
		],
	});
	$('#myTable3').on('click', '.myClass', function () {
		var tr = $(this).closest('tr');
		var row_idx = table3.row(tr).index();
		var dirs = table3.cell(row_idx, 4).data();
		var file = table3.cell(row_idx, 3).data();
		var groups = table3.cell(row_idx, 5).data();
		var max_plot_per100 = 4;
		var height = 100 * (1 + Math.max(0, Math.max(...groups) - max_plot_per100) / max_plot_per100);
		var err_plot_height = 0.18 * 100 / height;
		var dict_var_info = {};  // dict of array of dicts (to handle multiple plots for one variable)
		table3.cell(row_idx, 1).data().forEach( function(v, idx) {
			(dict_var_info[v] = dict_var_info[v] || []).push({group: groups[idx], dir: dirs[idx]});
		});
		$.get('$COMP_DIR/plot.html', function(data) {
			var new_data = data.replace('$DICT_VAR_INFO', JSON.stringify(dict_var_info));
			new_data = new_data.replace('$TITLE', file);
			new_data = new_data.replace('$HEIGHT', height + '%');
			new_data = new_data.replace('$ERR_PLOT_HEIGHT', err_plot_height);
			var strWindowFeatures = "menubar=yes, location=yes, resizable=yes, scrollbars=yes, status=yes";
			var win = window.open('', '_blank', strWindowFeatures);
			win.document.write(new_data);
			win.document.close();  // necessary for the scripts on the page to be executed
			// win.document.title = file;
		});
  });
});
</script>
</html>